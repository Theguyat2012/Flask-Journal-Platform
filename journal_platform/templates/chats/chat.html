{% extends "layouts/layout.html" %}

{% block content %}
    <div class="container">
        {% for user in chat_users %}
            {% if user.id != current_user.id %}
                <h1>{{ user.username }}</h1>
            {% endif %}
        {% endfor %}
        <div class="col" id="messages">
            {% for message in messages %}
                {% if current_user.id == message.user_id %}
                    <div class="row ms-auto w-50">
                        <p>{{ message.content }}</p>
                    </div>
                {% else %}
                    <div class="row me-auto w-50">
                        <p>{{ message.content }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <input type="text" id="myMessage">
        <button id="sendbutton">Send</button>
    </div>
{% endblock %}

{% block script %}
<script type="text/javascript" charset="utf-8">
    var socket = io();
    // socket.on('connect', function() {
    //     alert("a");
    // });

    socket.on('message', function(json) {
        document.getElementById("myMessage").value = "";

        var messages = document.getElementById('messages');

        var newRow = document.createElement('div');
        if ("{{ current_user.id }}" == json['user_id']) {
            newRow.setAttribute('class', 'row ms-auto w-50');
        } else {
            newRow.setAttribute('class', 'row me-auto w-50');
        }

        var newP = document.createElement('p');
        newP.innerHTML = json['message'];

        newRow.appendChild(newP);
        messages.appendChild(newRow);
    });

    document.getElementById("sendbutton").addEventListener("click", function() {
        var json = {'message': document.getElementById("myMessage").value, 'user_id': '{{ current_user.id }}', 'chat_id': '{{ chat.id }}'};
        socket.emit('send_message', json);
        socket.send(json);
    });
</script>
{% endblock %}
